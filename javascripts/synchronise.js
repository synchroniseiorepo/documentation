var Synchronise;dependenciesLoader(["io","$","_","Persist"],function(){Synchronise=function(){function e(e,n){var t=Array();"undefined"!=typeof n&&(t=Array.isArray(n)?n:[n]);var i=_.filter(Object.keys(e),function(e){return-1==t.indexOf(e)}),r=_.sortBy(i,function(e){return e}),o="";return _.each(r,function(n){"realtime"!=n&&(o+="object"==typeof e[n]?n+JSON.stringify(e[n]):n+e[n])}),o}var n,t=function(n,t,i){this.shouldCache=!1,this.functionName=n,this.params=t,this.firstCalled=!1,this.realtime=i,this.callbacks={},this.identifier=n+e(t,i.ignore),this.timestamp=new Date,this.callbacks={}},i=new Persist.Store("siowebinterface",{defer:!1}),r="https://www.synchronise.io";n=r;var o=io.connect(r,{reconnect:!1,"try multiple transports":!1,transports:["websocket","flashsocket","htmlfile","xhr-polling","jsonp-polling","polling"],path:"/socket.io"}),a={},u={},s=!1;o.on("connect",function(e){s=!0,_.each(d,function(e){"undefined"!=typeof e.connected&&e.connected()})});var d=Array(),c=!1;o.on("disconnect",function(){s=!1,c||f()}),window.setInterval(function(){s&&o.emit("dummy","")},500);var f=function(){$.ajax("/").success(function(){c=!1,o.io.reconnect()}).error(function(e){_.each(d,function(n){"undefined"!=typeof n.lost&&n.lost(e)}),window.setTimeout(function(){f()},500)})};o.on("Cloud.run",function(e){if(a.hasOwnProperty("Cloud.run")){var n=a["Cloud.run"][e.identifier];_.each(Object.keys(n),function(t){var r=n[t],o=!1;if(r.firstCalled||r.shouldAbort?(r.identity.realtime&&!r.shouldAbort||100==e.status)&&(o=!0):o=!0,a["Cloud.run"][e.identifier][t].shouldAbort=!1,o){if(a["Cloud.run"][e.identifier][t].stepsDone=e.stepsDone,a["Cloud.run"][e.identifier][t].totalSteps=e.steps,a["Cloud.run"][e.identifier][t].identity.progress={percentage:Math.round(e.stepsDone/e.steps*100),totalSteps:e.steps,currentStep:e.stepsDone},206!=e.status){a["Cloud.run"][e.identifier][t].identity.amountOfCalls=a["Cloud.run"][e.identifier][t].identity.amountOfCalls+1;var s=u["Cloud.run"];if(s=s[e.identifier],s=s[t],"undefined"!=typeof s&&s.hasOwnProperty(e.uniqueRealtimeID)&&(s=s[e.uniqueRealtimeID]),s){s.endCommunication=new Date,s.executionTime=e.executionTime,s.communicationTime=s.endCommunication.getTime()-s.startCommunication,a["Cloud.run"][e.identifier][t].identity.executions.push({measurement:"milliseconds",communicationTime:s.communicationTime,executionTime:s.executionTime});var d=a["Cloud.run"][e.identifier][t].identity.executions;a["Cloud.run"][e.identifier][t].identity.lastRequest=d[d.length-1],a["Cloud.run"][e.identifier][t].identity.firstRequest=d[0],a["Cloud.run"][e.identifier][t].identity.allRequests=d,a["Cloud.run"][e.identifier][t].identity.longestRequest=_.max(d,function(e){return e.executionTime+e.communicationTime}),a["Cloud.run"][e.identifier][t].identity.shortestRequest=_.min(d,function(e){return e.executionTime+e.communicationTime}),a["Cloud.run"][e.identifier][t].identity.averageRequestTime=_.reduce(d,function(e,n){return e+n.executionTime+n.communicationTime},0)/(0===d?1:d.length)}}if(200==e.status&&(n[t].firstCalled=!0,"undefined"!=typeof r.callbacks.success)){var c=JSON.parse(e.message);if(r.shouldCache){var f=i.get("cacheData");f||(f="{}");var l=JSON.parse(f);l[r.identifier]={data:c,type:typeof c,timestamp:(new Date).getTime()},i.set("cacheData",JSON.stringify(l))}r.callbacks.success(c)}500==e.status&&(n[t].firstCalled=!0,"undefined"!=typeof r.callbacks.error&&r.callbacks.error(JSON.parse(e.message))),"undefined"!=typeof r.callbacks.progress&&206==e.status&&r.callbacks.progress(a["Cloud.run"][e.identifier][t].identity.progress,JSON.parse(e.message)),100==e.status&&"undefined"!=typeof r.callbacks.log&&r.uniqueRequestID==e.uniqueRequestID&&r.callbacks.log(JSON.parse(e.message).log),"undefined"!=typeof r.callbacks.always&&206!=e.status&&100!=e.status&&(a["Cloud.run"][e.identifier][t].identity.hasFinished=!0,r.callbacks.always())}})}}),o.on("Cloud.dataUpdate",function(e){var n=e.channel,t=e.identifier;if(a.hasOwnProperty("Cloud.run")&&a["Cloud.run"].hasOwnProperty(t)){var i=a[n][t][Object.keys(a[n][t])[0]];i.params.realtime=!1,p({channel:n,uniqueRequestID:i.uniqueRequestID,data:{params:i.params,room:i.functionName,identifier:t}})}}),o.on("Cloud.requiresPassword",function(e){var n=JSON.parse(e.message);modalMessage.getTempPassword(n.reason,function(n){var t=Array();"undefined"!=typeof a&&"undefined"!=typeof a["Cloud.run"]&&"undefined"!=typeof a["Cloud.run"].hasOwnProperty(e.identifier)&&(t=a["Cloud.run"][e.identifier]),n===!1?(_.each(t,function(e){"undefined"!=typeof e.callbacks.abort&&(e.callbacks.abort("User authentication aborted"),e.callbacks.always())}),p({channel:"Cloud.passwordAuthenticationAborted",data:{params:{realtime:!1},room:"",identifier:e.indentifier}})):p({channel:"Cloud.passwordForAuthentication",data:{params:{realtime:!1,password:n},room:"",identifier:e.identifier}})},!0)});var l,p=function(e){var n=window.setInterval(function(){if(o.connected){window.clearInterval(n);var t=new Date,i=e.data.identifier+t.getTime();"Cloud.run"==e.channel&&_.each(a[e.channel][e.data.identifier],function(n){var t=!1;n.firstCalled?n.realtime&&(t=!0):t=!0,t&&("undefined"==typeof u[e.channel]&&(u[e.channel]={}),"undefined"==typeof u[e.channel][e.data.identifier]&&(u[e.channel][e.data.identifier]={}),"undefined"==typeof u[e.channel][e.data.identifier][n.uniqueRequestID]&&(u[e.channel][e.data.identifier][n.uniqueRequestID]={}),u[e.channel][e.data.identifier][n.uniqueRequestID][i]={startCommunication:new Date,endCommunication:void 0,executionTime:void 0})}),o.emit(e.channel,_.extend(e.data,{realtimeRequestID:i,uniqueRequestID:e.uniqueRequestID}))}},1)},y=[];return{debug:function(e){return i.set("debug",e),e?"Debug mode activated":"Debug mode deactivated"},init:function(e){l=e},Connection:{Lost:function(e){d.push({lost:e})},Connected:function(e){d.push({connected:e})}},LocalStorage:{public_key:l,get:function(e,n,t,r,o){var a=i.get(e);"undefined"!=typeof a&&null!==a&&n(JSON.parse(a).value);var u={};return u.key=e,u.realtime=!1,"undefined"!=typeof r&&("undefined"!=typeof r.ignore?Array.isArray(r.ignore)?u.realtime={ignore:r.ignore.concat(["defaultValue"])}:u.realtime={ignore:[r.ignore,"defaultValue"]}:u.realtime={ignore:"defaultValue"}),"undefined"!=typeof t&&(u.defaultValue=t),"undefined"==typeof o||o?Synchronise.Cloud.run("userSetting",u,{success:function(t){var r=t;i.set(e,JSON.stringify({value:r})),n(r)},error:function(e){n(e)}}):void 0},set:function(e,n,t){i.set(e,JSON.stringify({value:n})),("undefined"==typeof t||t)&&Synchronise.Cloud.run("userSettingSet",{key:e,value:n},{})}},Cloud:{run:function(n,r,o){var u=!1;"undefined"!=typeof r.realtime&&(u=r.realtime,delete r.realtime);var s="Cloud.run",d=!0;"undefined"==typeof o?d=!1:"undefined"==typeof o.success&&"undefined"==typeof o.error&&"undefined"==typeof o.abort&&(d=!1);var c=Boolean(r.cacheFirst);delete r.cacheFirst;var f=new t(n,r,u);if(f.shouldCache=c,c&&o&&o.hasOwnProperty("success")){var y=i.get("cacheData");if(y){var h=JSON.parse(y)[f.identifier];h&&(o.hasOwnProperty("always")&&o.always(),o.success(h.data))}}d||"true"!=i.get("debug")||("undefined"!=typeof console.warn?console.warning("You did not declare a callback for the function '"+n+"'. Add the declaration like this : \nSynchronise.Cloud.run('"+n+"', {parameters ...}, {\n    success: function(data){\n    },\n    error: function(err){\n    },\n    abort: function(reason){\n    }\n});"):console.log("You did not declare a callback for the function '"+n+"'. Add the declaration like this : \nSynchronise.Cloud.run('"+n+"', {parameters ...}, {\n    success: function(data){\n    },\n    error: function(err){\n    },\n    abort: function(reason){\n    }\n});"));var m,g=(new Date).getTime().toString()+(Math.floor(999*Math.random())+1);"object"==typeof u&&null!==u?"undefined"!=typeof u.ignore&&(m=n+e(r,u.ignore)+g):m=n+e(r)+g,f.uniqueRequestID=m,f.identity={abort:function(){this.shouldAbort=!0},setRealtime:function(e){!this.realtime&&e&&(this.realtime=!0,f.params.realtime=!0,p({channel:s,data:{params:f.params,pk:l,room:f.functionName,identifier:f.identifier,skipExecution:!0,realtime:!0}})),this.realtime&&!e&&(p({channel:"Cloud.unsubscribeRealtime",data:{uniqueID:this.uniqueRequestID}}),this.realtime=!1)},isRealtime:function(){return this.realtime},hasStarted:function(){return this.hasStarted},hasFailed:function(){return this.failed},hasSucceeded:function(){return this.succeeded},hasAborted:function(){return this.aborted},hasFinished:function(){return this.finished},run:function(){this.failed=!1,this.succeeded=!1,this.aborted=!1,this.hasFinished=!1,this.hasStarted=!0,p({channel:s,uniqueRequestID:f.uniqueRequestID,data:{realtime:this.realtime,pk:l,params:f.params,room:f.functionName,identifier:f.identifier}})},amountOfCalls:0,progress:0},f.callbacks={success:function(e){f.identity.succeeded=!0,"undefined"!=typeof o&&"undefined"!=typeof o.success&&o.success(e)},error:function(e){f.identity.failed=!0,"undefined"!=typeof o&&"undefined"!=typeof o.error&&("string"==typeof e?o.error(JSON.parse(e)):o.error(e))},always:function(){f.identity.finished=!0,"undefined"!=typeof o&&"undefined"!=typeof o.always&&o.always()},abort:function(){f.identity.aborted=!0,"undefined"!=typeof o&&"undefined"!=typeof o.abort&&o.abort()},progress:function(e,n){"undefined"!=typeof o&&"undefined"!=typeof o.progress&&o.progress(e,n)},log:function(e){"undefined"!=typeof o&&"undefined"!=typeof o.log&&o.log(e)}},"true"==i.get("debug")&&(f.identity=_.extend(f.identity,{averageRequestTime:void 0,longestRequest:void 0,shortestRequest:void 0,lastRequest:void 0,firstRequest:void 0,allRequests:void 0}));var v={realtime:u,stepsDone:0,totalSteps:1,failed:!1,succeeded:!1,aborted:!1,finished:!1,started:!1,executing:!1,shouldAbort:!0,executions:Array(),longestRequest:void 0,shortestRequest:void 0,uniqueRequestID:f.uniqueRequestID};return"undefined"!=typeof Object.defineProperty?_.each(Object.keys(v),function(e){Object.defineProperty(f.identity,e,{enumerable:!1,writable:!0}),f.identity[e]=v[e]}):f=_.extend(f,v),a.hasOwnProperty(s)||(a[s]={}),a[s].hasOwnProperty(f.identifier)||(a[s][f.identifier]={}),a[s][f.identifier][f.uniqueRequestID]=f,function(){return a[s][f.identifier][f.uniqueRequestID].identity.run(),a[s][f.identifier][f.uniqueRequestID].identity}()}},User:{current:function(){var e=i.get("user");return"undefined"!=typeof e&&null!==e&&"undefined"!=e&&null!==e?(e=JSON.parse(e),e.isAdmin=function(){var n=!1;return _.each(e.roles,function(e){("admin"==e.name||"superadmin"==e.name||"docwriter"==e.name||"marketplace"==e.name||"marketplaceValidation"==e.name)&&(n=!0)}),n},e):void 0},auth_token:function(){var e=i.get("auth_token");return e?e:void 0},fetchingCurrentUser:!1,fetchCurrent:function(e){"undefined"!=typeof e&&y.push(e);var n=this;n.fetchingCurrentUser||(n.fetchingCurrentUser=!0,Synchronise.Cloud.run("getCurrentSession",{realtime:!0,cacheFirst:!0},{success:function(n){n?(i.set("auth_token",n.session),i.set("user",JSON.stringify(n.user)),"undefined"!=typeof e&&_.each(y,function(e){e(n.user)})):(i.set("auth_token",void 0),i.set("user",void 0),"undefined"!=typeof e&&_.each(y,function(e){e(!1)}))},error:function(e){console.log(e)},always:function(){n.fetchingCurrentUser=!1}}))},logIn:function(e,n,t){var r={email:e,password:n};Synchronise.Cloud.run("login",r,{success:function(e){AWS.config.credentials=new AWS.CognitoIdentityCredentials({IdentityPoolId:"us-east-1:1699ebc0-7900-4099-b910-2df94f52a030",Logins:{synchroniseio:e.authToken}}),i.set("auth_token",e.authToken);var n=!0;Synchronise.Cloud.run("userObject",{user_id:e.user_id,token:e.authToken,realtime:!0},{success:function(r){i.set("user",JSON.stringify(r)),"undefined"!=typeof t.success&&n&&(n=!1,t.success(e))},error:function(e){"undefined"!=typeof t.error&&t.error(e)}})},error:function(e){"undefined"!=typeof t.error&&t.error(e)},always:function(){"undefined"!=typeof t.always&&t.always()}})},logOut:function(){i.set("auth_token",void 0),i.set("user",void 0),i.set("cacheData",JSON.stringify({}))}},Component:{run:function(e,n,t){return Synchronise.Cloud.run("executeComponent",_.extend(n,{id_component:e}),t)}},File:{upload:function(e,n,t){function i(n,t,i){Synchronise.Cloud.run("uploadGetSignature",{folder:t,file_type:n.type},{success:function(t){var s=new XMLHttpRequest;s.open("PUT",t.signed_request),s.addEventListener("progress",function(n){var t=n.loaded/n.total;o[u]=t,r=0;for(var a=0;a<e.length;a++)r+=o[u];"undefined"!=typeof i.progress&&i.progress(r)},!1),s.setRequestHeader("x-amz-acl","public-read"),s.onload=function(){200===s.status&&(a.push(t),a.length==e.length&&i.success(a),"undefined"!=typeof i.always&&i.always())},s.onerror=function(){},s.send(n)},error:function(e){"undefined"!=typeof i.error&&i.error(e),"undefined"!=typeof i.always&&i.always()}})}for(var r=0,o=Array(),a=Array(),u=0;u<e.length;u++)i(e[u],n,t);e.length||(t.success([]),"undefined"!=typeof t.always&&t.always())}}}}()});